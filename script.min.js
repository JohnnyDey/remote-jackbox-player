let formReady=t=>{"loading"!=document.readyState?t():document.addEventListener("DOMContentLoaded",t)};formReady((()=>{let t,e,n=document.getElementById("player"),a=document.getElementById("streamPane"),o=document.getElementById("unknownStream"),l=document.getElementById("twitchStream"),s=document.getElementById("howTo"),r=document.getElementById("gamePane"),i=document.getElementById("gameFrame"),c=document.getElementById("streamURLBar"),d=document.getElementById("streamURL"),u=document.getElementById("menuItems"),m=document.getElementById("menuButton"),h=document.querySelectorAll(".swapViewButton"),g=document.querySelectorAll(".swapViewButtonWrapper"),p="default",w="Remote Jackbox Player",v=null,f="",L="",y="",E="";const B="https://jackbox.fun",b=n.getAttribute("class"),I=a.getAttribute("class"),S=r.getAttribute("class"),A=g.item(0).getAttribute("class");function x(){"swap"==p?(g.forEach((t=>{t.classList.remove("lg:hidden"),t.classList.remove("hidden")})),document.getElementById("reloadStreamButton").classList.remove("lg:rounded-l"),document.getElementById("reloadGameButton").classList.remove("lg:rounded-l"),document.getElementById("reloadStreamButton").classList.remove("rounded-l"),document.getElementById("reloadGameButton").classList.remove("rounded-l")):(g.forEach((t=>{t.classList.remove("lg:hidden"),t.classList.add("hidden")})),document.getElementById("reloadStreamButton").classList.remove("lg:rounded-l"),document.getElementById("reloadGameButton").classList.remove("lg:rounded-l"),document.getElementById("reloadStreamButton").classList.add("rounded-l"),document.getElementById("reloadGameButton").classList.add("rounded-l"))}function T(){a.classList.contains("z-10")?(a.classList.add("z-20"),a.classList.remove("z-10"),r.classList.add("z-10"),r.classList.remove("z-20")):(r.classList.add("z-20"),r.classList.remove("z-10"),a.classList.add("z-10"),a.classList.remove("z-20"))}function k(t){"default"===t?(p="default",n.setAttribute("class",b),a.setAttribute("class",I),r.setAttribute("class",S),g.forEach((t=>{t.setAttribute("class",A)}))):"split"===t?(p="split",x(),n.setAttribute("class","flex flex-row w-screen h-screen"),a.setAttribute("class","relative w-1/2"),r.setAttribute("class","relative w-1/2")):"swap"===t?(p="swap",x(),n.setAttribute("class","w-screen h-screen"),a.classList.contains("z-10")?(a.setAttribute("class","absolute z-10 w-full h-full"),r.setAttribute("class","absolute z-20 w-full h-full")):(a.setAttribute("class","absolute z-20 w-full h-full"),r.setAttribute("class","absolute z-10 w-full h-full"))):"scroll"===t?(p="scroll",x(),n.setAttribute("class",""),a.setAttribute("class","relative w-full h-screen"),r.setAttribute("class","relative w-full h-screen")):"swipe"===t&&(p="swipe",x(),n.setAttribute("class","flex flex-no-wrap w-screen h-screen overflow-x-auto"),a.setAttribute("class","relative flex-none w-full h-full"),r.setAttribute("class","relative flex-none w-full h-full")),localStorage.setItem("rjp-activeView",t)}function _(t){let e=t;e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");let n=new RegExp("[\\?|&]"+e+"=([^&#]*)").exec("?"+v.toString().split("?")[1]);return null===n?"":decodeURIComponent(n[1].replace(/\+/g,"%20"))}function j(t){console.log("parse"),console.log("query");let e=t;e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");let n=new RegExp("[\\#|&]"+e+"=([^&#]*)").exec("#"+v.toString().split("#")[1]);return null===n?"":decodeURIComponent(n[1].replace(/\+/g,"%20"))}function $(){d.value!==f&&d.value.toString().length>8?(i.src="",i.src=B,f=d.value,""!=f?(document.title=`${w} - ${f}`,v.searchParams.set("streamURL",d.value),window.history.pushState(null,null,"/remote-jackbox-player?streamURL="+encodeURIComponent(f))):(document.title=`${w}`,v.searchParams.delete("streamURL"),window.history.pushState(null,null,"/remote-jackbox-player"))):d.value.toString().length<9&&(document.title=`${w}`,v.searchParams.delete("streamURL"),window.history.pushState(null,null,"/remote-jackbox-player"))}function z(){v=new URL(document.location.href.toString()),f=_("streamURL"),null!==localStorage.getItem("rjp-twitchAuthToken")&&(L=localStorage.getItem("rjp-twitchAuthToken")),""!==j("access_token")&&(L=j("access_token"),localStorage.setItem("rjp-twitchAuthToken",L),window.history.pushState(null,null,window.location.pathname+window.location.search)),""!==_("error")&&("The user denied you access"===_("error_description")?(alert("Чтобы найти случайного стримера или смотреть из списка отслеживаемых, пожалуйста, авторизуйтесь в Twitch."),"random"===localStorage.getItem("rjp-afterAuthAction")&&localStorage.removeItem("rjp-afterAuthAction")):(localStorage.removeItem("rjp-twitchAuthToken"),W("stream"))),null!==localStorage.getItem("rjp-afterAuthAction")&&("random"===localStorage.getItem("rjp-afterAuthAction")?document.getElementById("randomStreamButton").click():f=localStorage.getItem("rjp-afterAuthAction"),localStorage.removeItem("rjp-afterAuthAction")),""!=f?(d.value=f,document.title=`${w} - ${f}`,H(),M("open"),t=setTimeout((()=>{M("close")}),3e3)):(document.title=`${w}`,window.innerWidth<768?(M("open"),setTimeout((()=>{U("close")}),3e3)):M("open"))}function R(t){function e(){o.classList.add("hidden"),o.src=""}function n(){s.classList.add("hidden")}function r(){l.classList.add("hidden"),l.innerHTML="",E=""}"twitch"==t?(l.classList.remove("hidden"),n(),e()):"howTo"==t?(s.classList.remove("hidden"),a.scrollIntoView(!0),e(),r(),C("open")):(o.classList.remove("hidden"),n(),r())}function H(){if(""!=d.value)if("https://".startsWith(d.value.toString())||(d.value=d.value.toString().replace(/http:\/\//g,""),d.value=d.value.toString().replace(/https:\/\//g,""),d.value=`https://${d.value.toString()}`),d.value.toString().includes("remote-jackbox-player"))document.getElementById("howToButton").click();else if(d.value.toString().includes("twitch.tv")){if(""===E||E!==d.value.toString().split("/")[3]){E=d.value.toString().split("/")[3],R("twitch");let t=()=>{try{var t=new Twitch.Embed("twitchStream",{allowfullscreen:!1,width:"100%",height:"100%",channel:E,theme:"dark",layout:"video-with-chat",autoplay:!0});t.addEventListener(Twitch.Embed.VIDEO_READY,(()=>{t.getPlayer().play()}))}catch(t){console.error("Twitch embed setup error: \n%o",t)}};if(null==document.getElementById("ttvEmbedScript")||null==document.getElementById("ttvEmbedScript")){let e=document.createElement("script");e.setAttribute("id","ttvEmbedScript"),e.setAttribute("src","https://embed.twitch.tv/embed/v1.js"),e.addEventListener("load",t),document.body.appendChild(e)}else l.innerHTML="",t()}}else R(),o.src!==d.value&&(o.src=d.value);else document.getElementById("howToButton").click()}function C(t){"open"==t?(V("1.0"),c.classList.add("w-full"),c.classList.remove("w-0"),setTimeout((()=>{document.querySelectorAll("#streamURLBarTitleHelpText > .titleHelpText").forEach((t=>{t.classList.add("opacity-100"),t.classList.remove("opacity-0")}))}),1e3)):"close"==t&&(d.blur(),document.querySelectorAll("#streamURLBarTitleHelpText > .titleHelpText").forEach((t=>{t.classList.add("opacity-0"),t.classList.remove("opacity-100")})),setTimeout((()=>{c.classList.add("w-0"),c.classList.remove("w-full")}),500))}function U(t){"open"==t?(m.innerHTML='<i class="fas fa-times" aria-hidden="true"></i>',u.classList.remove("h-0"),u.style.height=2.5*u.childElementCount+"rem",m.title="Close menu",m.classList.remove("bg-white"),m.classList.remove("rounded-r"),m.classList.add("rounded-br"),m.classList.add("bg-teal-300"),m.classList.add("shadow-inner"),setTimeout((()=>{document.querySelectorAll(".menuItem > .titleHelpText").forEach((t=>{t.classList.add("opacity-100"),t.classList.remove("opacity-0")})),document.querySelectorAll(".control > .titleHelpText").forEach((t=>{t.classList.add("opacity-100"),t.classList.remove("opacity-0")}))}),500)):"close"==t&&(document.querySelectorAll(".menuItem > .titleHelpText").forEach((t=>{t.classList.add("opacity-0"),t.classList.remove("opacity-100")})),document.querySelectorAll(".control > .titleHelpText").forEach((t=>{t.classList.add("opacity-0"),t.classList.remove("opacity-100")})),setTimeout((()=>{m.innerHTML='<i class="fas fa-bars" aria-hidden="true"></i>',u.classList.remove("h-0"),u.style.height="0rem",m.title="Open menu",m.classList.remove("bg-teal-300"),m.classList.remove("shadow-inner"),m.classList.remove("rounded-br"),m.classList.add("bg-white"),m.classList.add("rounded-r")}),500))}function M(t){C(t),U(t)}function D(){null!=t&&(clearTimeout(t),t=void 0)}function V(t){c.style.opacity=t}function q(t){t.preventDefault(),t.returnValue=""}async function P(){let t=await fetch("/remote-jackbox-player/feature-random-stream-game-ids.json");t.ok?(gameIdsFileJSON=await t.json(),e=Array.from(gameIdsFileJSON.twitch)):(console.error("HTTP-Error:"+t.status),alert("Хм...не удалось получть список игр. Попробуйте позже."),window.removeEventListener("beforeunload",q),location.reload())}function W(t){"random"===t?localStorage.setItem("rjp-afterAuthAction","random"):"stream"===t&&localStorage.setItem("rjp-afterAuthAction",f),window.removeEventListener("beforeunload",q),console.log("щас чето будет"),console.log(y),document.location.href=`https://id.twitch.tv/oauth2/authorize?client_id=${y}&redirect_uri=${"localhost"===window.location.hostname||"127.0.0.1"===window.location.hostname?"http://localhost:5500/":window.location.origin+window.location.pathname}&response_type=token`}document.getElementById("setupSplitViewButton").addEventListener("click",(()=>{k("split")})),h.forEach((t=>{t.addEventListener("click",(()=>{"swap"!=p&&k("swap"),T()}))})),document.getElementById("setupSwapViewButton").addEventListener("click",(()=>{"swap"==p?T():k("swap")})),document.getElementById("setupScrollViewButton").addEventListener("click",(()=>{k("scroll")})),document.getElementById("setupSwipeViewButton").addEventListener("click",(()=>{k("swipe")})),d.addEventListener("input",(()=>{H(),$(),V("1.0")})),d.addEventListener("focus",(()=>{D(),H(),$(),V("1.0"),async function(){let t=document.getElementById("followedStreamsList"),n=document.getElementById("followedStreamsListStatus");void 0===e&&await P();if(""!==L&&void 0!==e){n.classList.remove("hidden"),""===t.innerHTML?n.innerHTML="Generating list...":n.innerHTML="Updating list...";let a=await fetch("https://api.twitch.tv/helix/users",{headers:{"Client-ID":y,Authorization:`Bearer ${L}`}});if(a.ok){let n=await a.json(),o=[],l="";do{let t=await fetch(`https://api.twitch.tv/helix/users/follows?from_id=${n.data[0].id}&first=30&after=${l}`,{headers:{"Client-ID":y,Authorization:`Bearer ${L}`}}),a=await t.json(),s="";if(a.data.length>0){for(let t=0;t<a.data.length;t++)s+="user_id=",s+=a.data[t].to_id,t+1<a.data.length&&(s+="&");let t=await fetch(`https://api.twitch.tv/helix/streams?${s}`,{headers:{"Client-ID":y,Authorization:`Bearer ${L}`}});s="";for(let t=0;t<a.data.length;t++)s+="id=",s+=a.data[t].to_id,t+1<a.data.length&&(s+="&");let n=await fetch(`https://api.twitch.tv/helix/users?${s}`,{headers:{"Client-ID":y,Authorization:`Bearer ${L}`}});if(t.ok&&n.ok){let a=await t.json(),l=await n.json();for(let t=0;t<a.data.length;t++)for(let n=0;n<e.length;n++)if(e[n].game_id===a.data[t].game_id){let e=a.data[t];for(let n=0;n<l.data.length;n++)l.data[n].id===a.data[t].user_id&&(e.profile_image_url=l.data[n].profile_image_url);o.push(e)}}}l=void 0!==a.pagination.cursor?a.pagination.cursor:""}while(""!==l);o.length>0?(o.length,t.innerHTML="",o.forEach((n=>{let a="";for(let t=0;t<e.length;t++)e[t].game_id===n.game_id&&(a=e[t].game_name);t.innerHTML+=`\n\t\t\t\t\t\t\t<div \n\t\t\t\t\t\t\t\tclass="followedStream flex flex-row flex-no-wrap p-2 text-center align-middle cursor-pointer border-b border-solid border-gray-400 hover:bg-teal-100" \n\t\t\t\t\t\t\t\ttitle="${n.user_name+" playing "+a+" for "+(1===n.viewer_count?n.viewer_count+" viewer":0===n.viewer_count?"no one.":n.viewer_count.toLocaleString()+" viewers.")}" \n\t\t\t\t\t\t\t\tdata-stream-name="${n.user_name}"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t<div class="flex-initial w-4/12 text-left truncate">\n\t\t\t\t\t\t\t\t\t<img src="${n.profile_image_url}" class="inline w-6 rounded">\n\t\t\t\t\t\t\t\t\t<span class="font-bold">${n.user_name}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="flex-grow text-left truncate">\n\t\t\t\t\t\t\t\t\t<span class="underline">${a}</span>\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t<div class="flex-initial w-3/12 text-right">\n\t\t\t\t\t\t\t\t\t${1===n.viewer_count?n.viewer_count+" viewer":0===n.viewer_count?"No viewers":n.viewer_count.toLocaleString()+" viewers"}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t`})),document.querySelectorAll(".followedStream").forEach((t=>{t.addEventListener("click",(()=>{d.value=`https://twitch.tv/${t.getAttribute("data-stream-name")}`,H(),$()}))}))):t.innerHTML='\n\t\t\t\t\t\t<div class="p-2 text-center">\n\t\t\t\t\t\t\tSorry, none of your followed streams are playing a Jackbox game.\n\t\t\t\t\t\t</div>\n\t\t\t\t\t'}else t.innerHTML='\n\t\t\t\t\t<div class="p-2 text-center">\n\t\t\t\t\t\tWant to see which of your followed Twitch streams are playing Jackbox\n\t\t\t\t\t\tgames?<br />\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tid="authorizeTwitchAccessButton"\n\t\t\t\t\t\t\tclass="bg-purple-500 text-white rounded mt-1 px-4 py-1 hover:bg-purple-600"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tAuthorize <i class="fab fa-twitch"></i> access\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t';n.classList.add("hidden")}else t.innerHTML='\n\t\t\t\t<div class="p-2 text-center">\n\t\t\t\t\tWant to see which of your followed Twitch streams are playing Jackbox\n\t\t\t\t\tgames?<br />\n\t\t\t\t\t<button\n\t\t\t\t\t\tid="authorizeTwitchAccessButton"\n\t\t\t\t\t\tclass="bg-purple-500 text-white rounded mt-1 px-4 py-1 hover:bg-purple-600"\n\t\t\t\t\t>\n\t\t\t\t\t\tAuthorize <i class="fab fa-twitch"></i> access\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t',document.getElementById("authorizeTwitchAccessButton").addEventListener("click",(()=>{W("stream")}))}(),document.getElementById("followedStreamsListWrapper").classList.remove("scale-y-0"),(window.innerWidth<768||window.innerHeight<768)&&(document.getElementById("menu").classList.remove("mb-24"),document.getElementById("menu").classList.add("mb-6"))})),d.addEventListener("blur",(()=>{H(),$(),document.getElementById("followedStreamsListWrapper").classList.add("scale-y-0"),(window.innerWidth<768||window.innerHeight<768)&&(document.getElementById("menu").classList.remove("mb-6"),document.getElementById("menu").classList.add("mb-24"))})),document.getElementById("streamURLForm").addEventListener("submit",(function(t){H(),$(),M("close"),t.preventDefault()})),window.addEventListener("resize",(()=>{})),window.addEventListener("popstate",(()=>{z(),H()})),document.getElementById("shareButton").addEventListener("click",(()=>{D(),(t=>{const e=document.createElement("textarea");e.value=t,e.setAttribute("readonly",""),e.style.position="absolute",e.style.left="-9999px",document.body.appendChild(e);const n=document.getSelection().rangeCount>0&&document.getSelection().getRangeAt(0);e.select(),document.execCommand("copy"),document.body.removeChild(e),n&&(document.getSelection().removeAllRanges(),document.getSelection().addRange(n))})(v.toString().replace(v.hash,"")),document.getElementById("shareText").classList.add("px-1"),document.getElementById("shareText").classList.add("w-40"),document.getElementById("shareButton").classList.remove("rounded-r"),document.getElementById("shareTextDoppelganger").classList.add("px-1"),document.getElementById("shareTextDoppelganger").classList.add("w-40"),setTimeout((()=>{document.getElementById("shareText").classList.remove("px-1"),document.getElementById("shareText").classList.remove("w-40"),document.getElementById("shareButton").classList.add("rounded-r"),document.getElementById("shareTextDoppelganger").classList.remove("px-1"),document.getElementById("shareTextDoppelganger").classList.remove("w-40"),M("close")}),3e3)})),document.getElementById("howToButton").addEventListener("click",(()=>{Array.from(s.classList).includes("hidden")?(U("close"),R("howTo")):(H(),$())})),window.addEventListener("beforeunload",q),document.getElementById("reloadStreamButton").addEventListener("click",(()=>{E="",o.src="",H()})),document.getElementById("reloadGameButton").addEventListener("click",(()=>{let t=!1;t=window.confirm("Reload the game?\nYou may lose your spot in the lobby."),!0===t&&(i.src="",i.src=B)})),m.addEventListener("click",(()=>{m.title.includes("Open")?(M("open"),setTimeout((()=>{d.focus()}),1e3)):m.title.includes("Close")&&(M("close"),d.blur())})),document.getElementById("hideStreamURLBarButton").addEventListener("click",(()=>{C("close")})),document.querySelectorAll(".menuItem").forEach((t=>{t.addEventListener("mouseover",(()=>{D()}))})),document.querySelectorAll(".control").forEach((t=>{t.addEventListener("mouseover",(()=>{D()}))})),c.addEventListener("mouseover",(()=>{D(),V("1.0")})),c.addEventListener("mouseout",(()=>{""!=d.value&&V("0.5")})),document.getElementById("randomStreamButton").addEventListener("click",(async()=>{if(d.disabled=!0,d.value="Searching...",void 0===e&&await P(),""!==L&&void 0!==e){let a=[],o=[],l="";for(let t=0;t<e.length;){let n=await fetch(`https://api.twitch.tv/helix/streams?language=en&first=30&game_id=${e[t].game_id}&after=${l}`,{headers:{"Client-ID":y,Authorization:`Bearer ${L}`}});if(n.ok){let e=await n.json();for(let t=0;t<e.data.length;t++)e.data[t].viewer_count<8&&o.push(e.data[t]);o.length<30&&null!=e.pagination.cursor?l=e.pagination.cursor:(l="",o.forEach((t=>a.push(t))),o=[],t++)}else if(console.error("HTTP-Error:"+n.status),401===n.status)return W("random")}let s=(t=0,n=a.length,t=Math.ceil(t),n=Math.floor(n),Math.floor(Math.random()*(n-t))+t);d.value=`https://twitch.tv/${a[s].user_name}`,d.disabled=!1,H(),$()}else""===L&&W("random");var t,n})),document.getElementById("showStreamURLBarButton").addEventListener("click",(()=>{c.classList.toString().includes("w-full")?d.focus():(C("open"),setTimeout((()=>{d.focus()}),1e3))})),null!==localStorage.getItem("rjp-activeView")?k(localStorage.getItem("rjp-activeView")):localStorage.setItem("rjp-activeView",p),async function(){console.log("retrieveClientIds");let t=await fetch("/remote-jackbox-player/client-ids.json");if(console.log(t),t.ok){let e=await t.json();y=e["twitch-client-id"]}else console.error("Unable to get client ids. The application will not operate as intended. Please reload the page to try again.")}(),z()}));